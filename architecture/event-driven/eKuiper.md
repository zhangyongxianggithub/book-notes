ekuiper，超轻量物联网的边缘数据分析软件。它是一款可以运行在各类资源受限硬件上的轻量级物联网边缘分析、流式处理开源软件。ekuiper的一个主要目标在边缘端提供一个实时流式计算框架，与Flink类似，eKuiper的规则引擎允许用户使用基于SQL方式，或者Graph方式的规则，快速创建边缘端的分析应用。
```shell
docker run -p 9082:9082 -d --name ekuiper-manager -e DEFAULT_EKUIPER_ENDPOINT="http://172.25.104.177:9081" emqx/ekuiper-manager:latest
```
```shell
docker run -p 9081:9081 -d --name kuiper -e MQTT_SOURCE__DEFAULT__SERVER="tcp://broker.emqx.io:1883" lfedge/ekuiper:1.8-alpine
```
# 机构设计
LF Edge eKuiper是物联网数据分析和流式计算引擎。是一个通用的边缘计算服务或中间件，为资源有限的边缘网关或者设备而设计。采用Go语言编写。架构如下:
![eKuiper架构设计](./arch.png)
作为规则引擎，用户可以通过REST API或CLI提交计算作业即规则。eKuiper规则/SQL解析器或图规则解析器将解析、规划和优化规则，使其成为一系列算子的流程，如果需要的话，算子可以利用流式运行时和状态存储。算子之间是松耦合的，通过Go通道进行异步通信。受益于Go的并发模型，规则运行时可以做到: 
- 以异步和非阻塞的方式进行通信;
- 充分利用多核计算;
- 算子层可伸缩;
- 规则之间相互隔离。
这些有助于eKuiper实现低延迟和高吞吐量的数据处理。 在eKuiper种，计算工作以规则的形式呈现。规则以流的数据源为输入，通过SQL定义计算逻辑，将结果输出到动作/sink中。规则定义提交后，它将持续运行。它将不断从源获取数据，根据SQL逻辑进行计算，并根据结果触发行动。
## 关键概念
### 规则
每条规则都代表了在eKuiper中运行的一项计算工作。它定义了连续流数据源作为输入，计算逻辑和结果sink作为输出。
1. 规则生命周期
   目前，eKuiper只支持流处理规则，这意味着至少有一个规则源必须是连续流。规则一旦启动就会连续运行，只有在用户明确发送停止命令时才会停止。规则可能会因为错误或eKuiper实例退出而异常停止；
2. 规则关系
   同时运行多个规则是很常见的。由于eKuiper是一个单一的实例进程，这些规则在同一个内存空间中运行。规则在运行时上是分开的，一个规则的错误不应该影响其他规则。关于工作负载，所有的规则都共享相同的硬件资源。每条规则可以指定算子缓冲区，以限制处理速度，避免占用所有资源；
3. 规则流水线
   多个规则可以通过指定sink/源的联合点形成一个处理管道。例如，第一条规则在内存sink中产生结果，其他规则在其内存源中订阅该主题。除了一对内存sink/源，用户还可以使用mqtt或其他sink/源对来连接规则。
### Sources源
源（source）用于从外部系统中读取数据。数据源既可以是无界的流式数据，即流；也可以是有界的批量数据，即表。在规则中使用时，至少有一个源必须为流。源定义了如何连接到外部资源，然后采用流式方式获取数据。获取数据后，通常源还会根据定义的数据模型进行数据解码和转换。
1. 定义和运行
   在eKuiper中，定义数据源的流或者表之后，系统实际上只是创建了一个数据源的逻辑定义而非真正物理运行的数据输入。此逻辑定义可在多个规则的 SQL的from子句中使用。只有当使用了该定义的规则启动之后，数据流才会真正运行。默认情况下，多个规则使用同一个源的情况下，每个规则会启动一个独立的源的运行时，与其他规则中的同名源完全隔离。若多个规则需要使用完全相同的输入数据或者提高性能，源可定义为共享源，从而在多个规则中共享同一个实例;
2. 解码
   用户可以在创建源时通过指定format属性来定义解码方式。当前只支持json和binary两种格式。若需要支持其他编码格式，用户需要开发自定义源插件;
3. 数据结构
   用户可以像定义关系数据库表结构一样定义数据源的结构。部分数据格式本身带有数据结构，例如protobuf格式。用户在创建源时可以定义 schemaId来指向模式注册表(Schema Registry)中的数据结构定义。其中，模式注册表中的定义为物理数据结构，而数据源定义语句中的数据结构为逻辑数据结构。若两者都有定义，则物理数据结构将覆盖逻辑数据结构。此时，数据结构的验证和格式化将有定义的格式负责，例如protobuf。若只定义了逻辑结构而且设定了strictValidation，则在eKuiper的运行时中，数据会根据定义的结构进行验证和类型转换。若未设置验证，则逻辑数据结构主要用于编译和加载时的SQL语句验证。若输入数据为预处理过的干净数据或者数据结构未知或不固定，用户可不定义数据结构，从而也可以避免数据转换的开销；
4. 流
   源定义了与外部系统的连接方式。在规则中，根据数据使用逻辑，数据源可作为流或者表使用。详细信息请参见流和表。在eKuiper中，流指的是数据源的一种运行时形态。流定义需要指定其数据源类型以定义与外部资源的连接方式。数据源作为流使用时，源必须为无界的。在规则中，流的行为类似事件触发器。每个事件都会触发规则的一次计算;
5. 表
   表是源数据在当前时间的快照。我们支持两种类型的表：扫描表（Scan Table）和查询表（Lookup Table）。
   - 扫描表: 消费流数据作为变化日志，并持续更新表。与常见的代表批处理数据的静态表相比，扫描表可以随时间变化。所有的流数据源如MQTT、 Neuron源等都可以是扫描表源。扫描表从 v1.2.0 版本开始支持。
   - 查询表: 一个外部表，其内容通常不会被完全读取，仅在必要时进行查询。我们支持将实体表绑定为查询表，并根据需要生成查询命令（例如，数据库上的SQL）。请注意，不是所有的源类型都可以成为查询表源，只有像SQL源这样的有外部存储的源可以成为查询源。我们从v1.7.0版本开始支持查询表。
   - 扫描表: 表的数据源既可以是无界的也可以是有界的。对于有界数据源来说，其表的内容为静态的。若表的数据源为无界数据流，则其内容会动态变化。当前，扫描表的内容更新仅支持追加。用户创建表时，可以指定参数限制表的大小，防止占用过多内存。扫描表不能在规则中单独使用，必须与流搭配，通常用于与流进行连接。扫描表可用于补全流数据或作为计算的开关。
   - 查询表: 查询表不在内存中存储表的内容，而是引用外部表。显然，只有少数源适合作为查询表，这需要源本身是可查询的。支持的源包括：
     - 内存源：如果内存源被用作表类型，我们需要在内存中把数据积累成表。它可以作为一个中间环节，将任何流转换为查询表。
     - Redis：支持按Redis键查询。
     - SQL源：这是最典型的查询源。我们可以直接使用SQL来查询。
   与扫描表不同，查询表将与规则分开运行。因此，所有使用查询表的规则实际上可以查询同一个表的内容.
### Sinks动作
动作是用来向外部系统写入数据的。动作可以用来写控制数据以触发一个动作，还可以用来写状态数据并保存在外部存储器中。一个规则可以有多个动作，不同的动作可以是同一个动作类型。动作的结果是一个字符串。默认情况下，它将被编码为json字符串。用户可以通过设置dataTemplate来改变格式，它利用go模板语法将结果格式化为字符串。为了更详细地控制结果的格式，用户可以开发一个动作扩展。
### SQL查询
eKuiper中的SQL语言支持包括数据定义语言（DDL）、数据操作语言（DML）和查询语言。eKuiper中的SQL支持是ANSI SQL的一个子集，并有一些定制的扩展。当创建和管理流或表源时，SQL DDL和DML被用来作为命令的有效载荷。查看流和表以了解详情。在规则中，SQL查询被用来定义业务逻辑。请查看SQL参考了解详情。
### 扩展
## 流式处理
### 概览
流数据是随着时间的推移而产生的数据元素序列，流处理是对流数据的处理。与批处理不同，流数据会在产生后立即被逐一处理。流处理具有下面的特点:
- 无界数据: 流数据是一种不断增长的、无限的数据集，不能作为一个整体来操作;
- 无界的数据处理: 由于适用于无界数据，流处理本身也是无界的，工作负载可以均匀的分布在不同的时间;
- 低延迟、尽实时: 流处理可以在数据产生后就进行处理，以极低的延迟获得结果。
流处理将应用与分析统一起来。简化了整个基础设施，许多系统可以建立在一个共同的架构上，允许开发人员建立应用程序，使用分析结果来响应数据中的洞察力，采取行动。
在边缘侧，大部分的数据都是以连续流的形式诞生，如传感器事件等。随着物联网的广泛应用。越来越多的边缘计算节点需要访问云网络并产生大量的数据。为了降低通信成本，减少云端的数据量，同时提高数据处理的实时性，达到本地及时响应的目的，同时在网络断开的情况下进行本地及时数据处理，有必要在边缘引入实时流处理。
有状态的流处理是流处理的子集，计算保持上下文状态。有状态流处理的例子包括:
- 聚合事件以计算总和、计数或平均值时;
- 检测事件的变化;
- 在一系列事件中搜索一个模式。
状态信息可以通过窗口/状态API管理
### 时间属性
流数据一个随时间变化的数据序列，时间是数据䣌一个固有属性。流处理中，时间在计算中起着重要的作用。比如做基于时间段的聚合。时间的概念很重要。时间有2种类型:
- 事件时间，事件实际发生的时间
- 处理时间，在系统中观察到事件的时间
ekuiper2种时间概念都支持。一个支持事件时间的流处理器需要一种方法来衡量事件时间的进展，比如，创建一个小时的时间窗口时，内部的算子需要在事件时间超过一个小时后得到通知，算子可以发布正在进行的窗口。ekuiper衡量事件时间的进展的机制就是watermark，watermark作为数据流的一部分，带有一个时间戳$t$，一个watermark声明事件时间在该数据流种已经达到了时间$t$，意味着该数据流种不应该再有时间戳<=t的元素，在ekuiper中，watermark是在规则层面上的，这意味着当从多个数据流中读取数据时，水印将在所有输入流中流动。
### 窗口
由于流媒体数据是无限的，因此不可能将其作为一个整体来处理。窗口提供了一种机制，将无界的数据分割成一系列连续的有界数据来计算。内置的窗口2种:
- 时间窗口: 按时间分割的窗口，支持事件时间与处理时间;
- 计数窗口: 按元素计数分割的窗口
### 连接
连接是ekuiper中合并多个数据源的唯一方法。它需要一种方法来对其多个来源并触发连接结果。支持的连接包括:
- 多流的连接: 必须在一个窗口中进行
- 流和表的连接: 流将是连接操作的触发器。
支持的连接类型包括LEFT、RIGHT、FULL、CROSS。
