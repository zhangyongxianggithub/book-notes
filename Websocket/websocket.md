Here's the challenge: we've got a Kafka topic, where services publish messages to be delivered to browser-based clients through web sockets. Sounds simple? It might, but we're faced with an increasing number of messages, as well as a growing count of web socket clients. How do we scale our solution? As our system contains a larger number of servers, failures become more frequent. How to ensure fault tolerance? There’s a couple possible architectures. Each websocket node might consume all messages. Otherwise, we need an intermediary, which redistributes the messages to the proper web socket nodes.

Here, we might either use a Kafka topic, or a streaming forwarding service. However, we still need a feedback loop so that the intermediary knows where to distribute messages.

We’ll take a look at the strengths and weaknesses of each solution, as well as limitations created by the chosen technologies (Kafka and web sockets).

We can hold it. The crease. Also our system exposed but he spotted his functionality through websockets and so we had some kind all right it looks a good note and you were not clients connect so that's why the connections terminate. So what I'm trying to open so what's a good connection they end up connecting to that websocket and when the connection is open only the website knows how how next the system note that the user is connected we won't be concerned here with and with that and what we would be concerned with is that at some point the services yes hi to send Sunday dozens of messages to the clients who are connected through the websites. So it the way the services the messages to the websockets historic Kafka broker is is. That strike did best the S. making here why we're using copper and the first place one wants to isolate the services from the website does not constitute a synchronous connection between them because it creates all kinds of inside it and it may cause errors okay make calls if if if the web technology slow alternated may because may impact the services so we don't want to do it wants to isolate those and it's with intermediate and component right so and when a microservice oh what a service designed to send messages to send a message to our client. What they do is they right in this message to my **** up a big. And then somehow let's look at the needs to read that message will become. And send it to the appropriate user so that will get worse right M. and this could be a state connection between the cuff and let's look at the old is what we would be getting with yes that's this single island it would be considering how we can actually implemented and what topic post on each social. So it actually the first thing that you notice okay one second dog is not free and not. And we might still wants to add more with circuit nope still always had I mean can we might want to do is put to reasons first of all yes of course all right. So if one of the websocket nodes dice every one the other one to take over right we don't want our system to become unavailable I thank god I think we'll probably once okay you still on these websites. Secondly there's a certain limit as to how many concurrent what's a good connections a single note it can handle and right it can be anything from thousands and to cancel thousands maybe hundreds of thousands depending you know what kind of additional work website no need to do ending on how many days I'm Sam and so on. There is a limit so at some point start over that you would want to sketch out naturally and more capacity your system by ending. So you may easily end up with like 5 or even 10 of these websocket poems set to star in all of the incoming truck and once you have one what's a good notes and and a single cut cut okay wed messages written so connections stops being and so obvious is. Being so obvious how to connect the store systems and. What is important to note considerations is that if we actually zoom into the. The topic is to pull away hello big actually consist of multiple partitions right each partition holds a subset of messages so when a service this site send a message and the time is right the message though and websocket it'll become a big. So what happens is the message ends up on one of the partitions so what partition and then decided by a petitioner and you can use and not the beta partition ours I did put it will be a test run the partition comment by the harsh message and implement a custom one and we will also be talking about how we might approach and that late. So yes so it. Summary statement we have a set of conditions that form a single topic sentences write messages to these partitions and we want to somehow woke data additions to the appropriate websocket knocks so how how how to connect the still. Before the evening. Intellectual solutions I am shocked summary who am I and why would I actually be able to talk about this but. N. so I've got a 14 years of experience in back end engineering I've been mainly using Scala is a programming language and the call that a Java I mean if I can look after and work as well we've been using our systems and I'm also and they do that holder an altar and some promoter and we hire company which develops custom software mainly because of distributed systems big data small data as well and machine learning blockchain messaging. Windows kakak let's set up or something and we quite often right on it longer and then use technical topics also related so and make sure to visit and maybe you will find something just so the first and probably the most obvious solution that might come to your mind is that every websocket no my treat all of the day right so if you have a single it's not like that's the only possible solution what happens if we have to have second thoughts well most of them read all the data all partitions and what they do local it is they are out the messages that it addressed to the clients while connected to the website right so on average each websocket though like well how old is the message. It is a simple solution so that's definitely a good side of that approach however what happens if we add more website owns thanks if we had this. Both one what if the network traffic would increase in early and end late this time with with the number all websocket norms right so why would they be sending in all of the data twice isn't such an overhand sending it all times if we had an old Methodist and ending what looks like a nose we don't really have a lot of messages one that might actually become a bottle neck and mind and unnecessary strain on our infrastructure. So this simple approach. Probably will work great if you have a smaller system well if you don't have such a high volume of messages the card that you sent home services to the website notes it won't work well in a moment and the big moment to skate out moment and Lois so what are the ultimate. So we might be tempted to create kind of an intelligent route right so how will that look. So when we're trying to connect hello it's a great notes when they need to be somehow directed to 1 of the steps okay all right so that kind of connection I'm sent so what's the connection some of this some kind of an old 1 answer which actually decides which which website okay and the kinds of connect so maybe we can do it in an intelligent way to actually connect I am the correct website which 1 would be the correct 1 well let's say you know if you have and then if you have a consumer group in the race for the cure have number of consumers join the consuming a single topic Hey each off such you talk about consumers and that consumers look M. will receive a unique set of conditions and that's the basis because you're right so if you have books notes and they close your messages topic and the pharmaceuticals group so that it doesn't concern groups that don't have prices if they promising local smoke so each of them will get assigned a unique options and although partition and you will be assigned right so here the past 1 week partitions wanted to end it second knowledge which responded since 3 and 4:00 AM so maybe we can use that knowledge actually direct lines to the right no right and how we can do that well the first thing we would have to do is we would have to use a custom partition are so that we know on which partition message I couldn't find 1 and so what we need to do is we might example when message sent. The petitioner is inspecting the message MC this message is addressed the username and I'm so and we take the hush 59 and this would end up on a farm right and this is a deterministic it's a deterministic. And so we know that as well this message is by giving you that will always end up on a given and partition so now the rotor it would also have to spank night this is a websocket this is opened by a user with 80 may 9 be ahead of me. So I know that so do it they know that unless you just want to end up being consumed by the second I'm sorry to cut let's connect the the user better. So it is an. I guess it is quite complex to implement because the the Longmont there is usually quite low level component and actually needs to know at all. Need to know about your ideas about how user I. D. I'm not partitions it would need to know what's the partition if I'm in the website okay so it would be quite challenging to implement such. M. it's probably doable but there's another problem with that what happens if we stay out and what happens and a new one I think you are. Then the partitions are assigned right now we have 3 consumers in our consumer book. So we need to create and we spoke a couple actually signed petitions to these and these notes well it's even in. We can see that and the first question is on what is consumed by the first no I didn't but the second one most of the second node and the fourth one is consumed by the new one right all right cool actually it keeps on turning with the return we would have to break all of the user connections and weather condition as time has shifted and they would have to reconnect with you know we don't have a way of migrating you collection I'm one of those right so this probably would be quite problematic and it would be very bad user experience I'm trying to buy you will get disconnected what's a good note because a no there has to be that that was a straight out. So this probably isn't the best solution so let's look for something better. We would need some kind of. Though component okay okay intermediate component which would actually meet mediate between the cockpit weather messages might be just a bit on a Sunday and and what's a good number when we had the client connect right so it's not going to read this regard is to read messages and send them to the group yet websocket. And then when they register guitar and we will I'm busted it wants to have this on that service all right so they will again don concealed there the messages topic as a consumer group so each practice each rep is because we have a unique subset of options I'm from which they read. So we the boxer of the register the first one is the foster mom so and we can consider how did with this you don't send messages to the website but there's also the back channel so did read this you don't have to know which clients are connected to which website. Thanks that's the kind assignment information. We need to be propagated although its second notes so they distribute so let's look at the store components and their culture and that they backed in and indeed so let's stop with the with the back to. So the first solution to implementing the back time actually leveraging. So what you might do is do it knows my right connection events within the greater cockatoo so each time and you can't connect and it was no right and events to Africa and you. These events are streamed through the redness becomes which building in memory you know where they had my fate between the user ID it's connected and is the popular website called switch who is the kind of clinic this might be I can I can I try and identify yourself. So it this is an implementation of big data bases okay yeah right so we are a stream of connect events in this through the lens is used to bet and if you will of the current state of the database the database table and the database table kia ace and. Fine which crimes connected to which what took right so if maybe a credit on the account it said that's a very nice description of how this M. database as a local company also bother your space I tell ya. The database inside out. We are working with it well they representational off of events instead of working with the materialized view. So this is something that we need to consider here and just not in the first one is that what most consider your and what should we get disconnected right no thanks fine thanks maybe M.. It is possible that disconnected one picture written so we have to be prepared for that so if nobody wants to have like and am. Maybe every 5 minutes I per minute. No service which would actually write an event it given client still connected to that website well it's kind of hard to beat that kind of let's face something that so each it. I can imagine that I'm still connected. And if you know what we assume that if not eventually compliance was written and that given enough time must have disconnected from that websocket. This way we can also see I. N. retention policy public topic. So that any data that was all that exciting I've minutes if that's the time interval data that's older than I am it's connection he removed from the topic maybe 6 minutes to allow for some for some slack in the distributors and hunky. We can keep the topic small so certainly is what about the way they were distributors they need school stream everything that's in there connect events topic and they need to bring that in memory of your right what if we just sent a couple of slides ago that streaming everything isn't a good solution yeah this is the reason is different and the number of connect and disconnect events should be much less what it what it is much much smaller than the number of messages flowing Chris is that right so why am sending each message what's a good note will create a huge and would make would have a huge impact on the network infrastructure stream connect and disconnect events. This will be not that many of them that maybe hundreds of thousands of them in every minute and buckets look like millions of anything that would actually over whether your system of course it depends on the actual often in which case and that's okay but if you had a lot of shoplift websockets maybe there's something wrong with the website. So this is the first approach to how we can implement it with this the second would be to use some kind of an in memory cache and maybe you had memcached installation maybe and original something that so and on the west side this is similar and every 5 minutes I have a minute they need to write a the cash that I am connected to an old. So in the end I think we are using read this so if you are using read this we got a hand and you can type yeah each side entry so that comes out after a couple of minutes so that you don't get state interest it was a good idea so that you can read this with me and I would say corresponds to the retention placing. They were distributor now used to be what right because and now when he wants to find out. Where where a given kind is connected we need to query the cash I've been to quite the best and then we know where to send the message I am so the problem with the potential problem here is that it we would need to go actually waste right and this will again create a bottleneck our system so it makes little difference because can create another cash which will actually hold the values that they acted they already read I'm so they would just they would just would have crashed and right this would be a second. I. Another downside is that you actually need to create another system and when used in other system now in the process right reusing Kafka might be cheaper operationally ready head working across let have to maintain it having a single system is that okay most read this it will already have it this might be cheaper so that's also something to consider and what's the operational overhead of introducing new subsystems. So that's how we can implement the Bechtel outlets comes today and what happens if one of the registered owner that's what a one of the reps but the nice. Well the other one will of course take over the partitions that. And the last time that for this bizarre this one important thing that might happen yeah I am so when you're reading from a cut cut okay you are streaming data from the partitions and yes sending them other right looks okay okay. And but in typical usage you check points that you have read the date so you acknowledge that you have read messages only from time to time right it is in their conferences called committing offsets so this call may also be banned I think is a probation which happens to me every health messages maybe every minute depends on on the actual usage and now we might is it right all set and after processing messages and that's the most narrow then we get on with this and we we write them this fall and Christmas messages and then then we got most of them if we write them off the processing method just so I can sponsor now you might have been that some residents of the west bank because that wouldn't I and if it's alright to send some some messages I would try it how would you didn't commit offense and they registered that takes over well it was thought from the commission also and it is possible that some of these messages will be sent to this websocket built twice and so we have to be prepared for that you might need yeah we like it it took guts and one solution here. I think it's a band some reason aids and to keep track of some people's ideas for a client and then once it goes connection no nice and what's like the highest that I sent. Right and they receive this 11 second Scott this message and because of my yeah and Dr. So how about implementing the following. When he is similar right the first solution would be to use a gun and again we have come across so you might as well use it so what we might do is we might head it indicated okay well we kind of song the messages basing on on the user I. D. some of the registered voters would have to know what's the partition assignment between the websocket notes and the website okay great at some point okay all websocket messages and writing in addition all at. Mr dystopic. So here we would have to use custom what's next time it so that each websocket note reads data from a single ad partition right. In the west I could not have to somehow get from using the back to look at the register snow which partition it what's a good note. I'm so they did not release the call is to move data optics from the messages okay Hey look at conditions in day websocket messages. Right so it's kind of a shopping messages. Shopping from the random one the appropriate websocket messages in partition and this might be implemented using Kafka streams a number. And what it what's it what's what what you have to keep in mind is that you need to implement a bunch I meant and you need to include information technology we feel much partition in the back to know that we have talked about it before. This second solution yet is to simply use HTTP R. yeah either through thank you because maybe you would want something that so if you're the solution will be that register because Iraq the connects to website so most of the east ridge runs before would have to connect you to put something out and well it's these messages and they were so good screens will complain and between the services so here again we have everything is nice and isolated tribes so. And it goes into S. notes won't have any impact on the registered with us and we want. And here we have it and what company you can consider it like a single websocket handing summons which consists of 2 components of the witness because all the website okay and again depends how much traffic you have how much of the complex thank. And how much of a selection you want in your system and so on and so on. In in this solution the downside is that the register each register has to connect each other let's look at the and stream that they thought their simple ability might work quite as well. So then let's see how it's gonna influence over the site right what what is it about after that made us actually introduced intermediate component and. What I like the **** architecture cocktail mystics actually did this hiding across here so the main feature of contradiction thank you how we can implement this feature is the fact that the cosco we have run this update and the limited set of conditions right so when you read the topic you specify how many politicians should have and you can increase member politicians and decrease the number of petitions but it's not something you do often right it requires intervention and it's more than 8 easy operation actually increase or decrease the number of capital X. gets easier each trainees and it is being improved but it's still the number of partitions and Kafka is around this topic and in limited. Mystical to given the given topic. And the fact that. Also the number of partitions that's also about this right you what we can have 100 partitions you can have all the partitions of 10 and a 10 K. on 100 Hey I'm afraid not so it doesn't make a big is I think and second right so this was all designed to act as its time addition and quick client and which will be probably the most obvious one and then they would look at those schools subscribe that will be it addition but it's not possible however it's still possible but with reason hi this looks and some. It's a byproduct it is and. By then okay Kunj decision actually implement that play that's where compound actually did partition design that's how Kafka implements plus times that's how it happened and it's stating right M. the fact that because the bike into partitions and and I was one who scraped each function independently you can also dispute the partitions close my notes so as you get one when they type in actually Hey Hey most servers and the server was only eight and take over a subset the topics they weren't by taking over a subset of the partitions right so these partisans here and I'm sure that each other it's needed to implement state right this post alerts right to your when an old face not everything is lost only after the partition in other notes it was replicating and publishing you can actually take over so the reasons you're not good and you know if you want to scare me large number all three times stay cool handle it a little bit you have to be put out some sometimes some limiting factors here inside the design on competitions that's what influence maybe call it a bit your article
未选择任何文件

